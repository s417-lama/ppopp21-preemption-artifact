#!/bin/bash
set -eo pipefail
export LC_ALL=C
export LANG=C

DATETIME=${DATETIME:-$(TZ='America/Chicago' date +%Y-%m-%d_%H-%M-%S)}
RESULT_DIR=${RESULT_DIR:-${PWD}/results}
OUT_FILE=${RESULT_DIR}/mkl_dgemm_${DATETIME}.out
ERR_FILE=${RESULT_DIR}/mkl_dgemm_${DATETIME}.err

make clean
CC=icc make mkl_dgemm
CC=icc make patch

export ABT_INITIAL_NUM_SUB_XSTREAMS=40

# KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 LOOKAHEAD=7 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=64 MKL_NUM_THREADS=4 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc OMP_NESTED=true MKL_DYNAMIC=false ./mkl_dgemm 64 1 0 1009 1009 1009
# KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 LOOKAHEAD=7 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=4 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc OMP_NESTED=true MKL_DYNAMIC=false ./mkl_dgemm 56 3 2 4000 4000 4000
# LD_PRELOAD=$(pwd)/libmklyield_skylake_sched.so ABT_PREEMPTION_INTERVAL_USEC=1000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=8 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false stdbuf -oL numactl -iall ./mkl_dgemm 14 10 2 4000 4000 4000 2> $ERR_FILE | tee $OUT_FILE
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=1000000000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=8 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false stdbuf -oL numactl -iall ./mkl_dgemm 14 10 2 4000 4000 4000 2> $ERR_FILE | tee $OUT_FILE

OUTER=32
INNER=16
REPEAT=2
WARMUP=1
N=4000
# echo "## iomp"
# LD_PRELOAD=${INTEL_DIR}/compiler/lib/intel64/libiomp5.so KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 MKL_NUM_THREADS=$INNER OMP_PROC_BIND=true OMP_NESTED=true MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
echo "## iomp (no bind)"
LD_PRELOAD=${INTEL_DIR}/compiler/lib/intel64/libiomp5.so KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 MKL_NUM_THREADS=$INNER OMP_NESTED=true MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
# echo "## patch, intvl=1000"
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=1000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=$INNER ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
# echo "## no patch, intvl=1000"
# LD_PRELOAD=$(pwd)/libmklyield_skylake_sched.so ABT_PREEMPTION_INTERVAL_USEC=1000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=$INNER ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
# echo "## patch, intvl=10000"
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=10000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=$INNER ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
# echo "## no patch, intvl=10000"
# LD_PRELOAD=$(pwd)/libmklyield_skylake_sched.so ABT_PREEMPTION_INTERVAL_USEC=10000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=$INNER ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
# echo "## patch, no preemption"
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=1000000000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=$INNER ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N
# echo "## no patch, no preemption"
# LD_PRELOAD=$(pwd)/libmklyield_skylake_sched.so ABT_PREEMPTION_INTERVAL_USEC=1000000000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=$INNER ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false numactl -iall ./mkl_dgemm $OUTER $REPEAT $WARMUP $N $N $N

# EVENT=context-switches
# # EVENT+=,faults
# # EVENT+=,branch-instructions,branch-misses
# EVENT+=,cache-references,cache-misses
# # EVENT+=,L1-dcache-loads,L1-dcache-load-misses
# # EVENT+=,L1-dcache-stores,L1-dcache-store-misses
# EVENT+=,LLC-loads,LLC-load-misses
# EVENT+=,LLC-stores,LLC-store-misses
# EVENT+=,node-loads,node-load-misses
# EVENT+=,node-stores,node-store-misses
# # EVENT+=,dTLB-loads,dTLB-load-misses
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=1000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=16 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false perf stat numactl -iall ./mkl_dgemm 14 10 2 4000 4000 4000
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=10000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=16 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false perf stat numactl -iall ./mkl_dgemm 14 10 2 4000 4000 4000
# LD_PRELOAD=$(pwd)/libmklyield_skylake.so ABT_PREEMPTION_INTERVAL_USEC=1000000000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=56 MKL_NUM_THREADS=16 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false perf stat numactl -iall ./mkl_dgemm 14 10 2 4000 4000 4000
# # LD_PRELOAD=${INTEL_DIR}/compiler/lib/intel64/libiomp5.so MKL_NUM_THREADS=16 OMP_PROC_BIND=true OMP_NESTED=true MKL_DYNAMIC=false perf stat numactl -iall ./mkl_dgemm 14 10 2 4000 4000 4000

# ABT_PREEMPTION_INTERVAL_USEC=10000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 LOOKAHEAD=7 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=64 MKL_NUM_THREADS=8 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false stdbuf -oL ./mkl_dgemm 16 10 2 4000 4000 4000 2> $ERR_FILE | tee $OUT_FILE
# LD_PRELOAD=$(pwd)/libmklyield_knl_sched.so ABT_PREEMPTION_INTERVAL_USEC=10000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 LOOKAHEAD=7 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=128 MKL_NUM_THREADS=8 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false stdbuf -oL ./mkl_dgemm 32 10 2 4000 4000 4000 2> $ERR_FILE | tee $OUT_FILE
# LD_PRELOAD=$(pwd)/libmklyield_knl.so ABT_PREEMPTION_INTERVAL_USEC=5000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 LOOKAHEAD=7 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=128 MKL_NUM_THREADS=8 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false stdbuf -oL ./mkl_dgemm 32 10 2 4000 4000 4000 2> $ERR_FILE | tee $OUT_FILE
# LD_PRELOAD=$(pwd)/libmklyield_knl.so ABT_PREEMPTION_INTERVAL_USEC=5000 KMP_ABT_WORK_STEAL_FREQ=4 KMP_ABT_FORK_CUTOFF=4 KMP_ABT_FORK_NUM_WAYS=4 ABT_SET_AFFINITY=1 KMP_BLOCKTIME=0 KMP_HOT_TEAMS_MAX_LEVEL=2 KMP_HOT_TEAMS_MODE=1 LOOKAHEAD=7 OMP_PROC_BIND=close,unset KMP_ABT_NUM_ESS=64 MKL_NUM_THREADS=8 ABT_THREAD_STACKSIZE=150000 ABT_MEM_MAX_NUM_STACKS=80 ABT_MEM_LP_ALLOC=malloc MKL_DYNAMIC=false stdbuf -oL ./mkl_dgemm 16 10 2 4000 4000 4000 2> $ERR_FILE | tee $OUT_FILE

ln -sf $OUT_FILE ${RESULT_DIR}/latest.out
ln -sf $ERR_FILE ${RESULT_DIR}/latest.err
